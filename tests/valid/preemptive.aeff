operation stop : int
operation go : int

let (waitForStop : int -> 'a) threadID =
  promise (stop threadID' k1 |->
    if threadID = threadID' then
      promise (go threadID' k2 |->
        if threadID = threadID' then
          <<()>>
        else k2 ()
      ) as p in
      await p until <<_>> in
      k1 ()
    else k1 ()
  ) as p in
  p

run
  waitForStop 1; 1 + 1 + 1 + 1 + 1

run
  waitForStop 2; 10 + 10 + 10 + 10 + 10